<!DOCTYPE html>
<html>
<head>
  <title>Raizz Capital - TV Novos Negócios</title>
  <script type="module" src="https://us-east-1.online.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
    </style>
    <link rel="icon" href="https://raizzcapital.com.br/wp-content/uploads/2024/02/logo-raizz-capital-fundo-branco.webp">
</head>
<body>
  <div id="vizContainer"></div>

  <script>
    const backendURL = "https://tableau-backend-h83x.onrender.com/get_tableau_url?painel=novos";
    const dashboards = [
      { nome: "Geral", view: "Especulativo" },
      { nome: "Tarefas Especulativo", view: "TarefasEspeculativo" },
      { nome: "Tarefas BTS", view: "TarefasBTS" }
    ];

    const tempoPorPainel = 60000;
    let currentIndex = 0;
    let vizElement = null;

    async function fetchToken() {
      const resp = await fetch(backendURL);
      if (!resp.ok) throw new Error("Erro backend: " + resp.status);
      return resp.json();
    }

    function buildEmbedUrl(embed_url, viewSlug) {
      const parts = embed_url.split("/views/");
      const prefix = parts[0] + "/views/";
      const after = parts[1] || "";
      const workbookSegment = after.split("/")[0];
      const params = embed_url.includes("?:") ? embed_url.substring(embed_url.indexOf("?:")) : "";
      return `${prefix}${workbookSegment}/${viewSlug}${params}`;
    }

    async function criarViz(viewSlug, jwt, embed_url) {
      const container = document.getElementById("vizContainer");
      container.innerHTML = "";
      const urlEmbed = buildEmbedUrl(embed_url, viewSlug);

      vizElement = document.createElement("tableau-viz");
      vizElement.src = urlEmbed;
      vizElement.token = jwt;
      vizElement.toolbar = "hidden";
      vizElement.hideTabs = true;
      container.appendChild(vizElement);

      console.log("Carregado painel viewSlug:", viewSlug, urlEmbed);
      vizElement.addEventListener("firstinteractive", () => {
        console.log("First interactive para", viewSlug);
      });
    }

    async function init() {
      try {
        const { embed_url, jwt } = await fetchToken();
        await criarViz(dashboards[currentIndex].view, jwt, embed_url);

        setInterval(async () => {
          currentIndex = (currentIndex + 1) % dashboards.length;
          const painel = dashboards[currentIndex];
          const tokenData = await fetchToken();
          await criarViz(painel.view, tokenData.jwt, tokenData.embed_url);
          console.log("Trocou para:", painel.nome);
        }, tempoPorPainel);

      } catch (error) {
        console.error("Erro init Novos Negócios:", error);
      }
    }
    init();
  </script>
</body>
</html>
